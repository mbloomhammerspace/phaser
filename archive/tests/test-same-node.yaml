apiVersion: batch/v1
kind: Job
metadata:
  name: test-same-node
  namespace: default
spec:
  template:
    spec:
      containers:
      - name: same-node-test
        image: curlimages/curl
        command:
        - /bin/sh
        - -c
        - |
          echo "=== TESTING SAME-NODE DOCUMENT PROCESSING ==="
          echo ""
          echo "‚úÖ SAME-NODE CONFIGURATION:"
          echo "  ‚Ä¢ All services pinned to instance-20251010-1127"
          echo "  ‚Ä¢ ingestor-server: 10.244.4.158"
          echo "  ‚Ä¢ nv-ingest-ms-runtime: 10.244.4.156"  
          echo "  ‚Ä¢ redis: 10.244.4.159"
          echo "  ‚Ä¢ No cross-node networking issues"
          echo ""
          echo "1. Testing ingestor-server health..."
          curl -s http://10.233.51.201:8082/health
          echo ""
          echo ""
          echo "2. Creating same-node test document..."
          echo "Same-Node Processing Test Document" > same_node_test.txt
          echo "" >> same_node_test.txt
          echo "This document tests processing with all services" >> same_node_test.txt
          echo "running on the same node to avoid networking issues." >> same_node_test.txt
          echo "" >> same_node_test.txt
          echo "Configuration Details:" >> same_node_test.txt
          echo "- All services on instance-20251010-1127" >> same_node_test.txt
          echo "- Redis connectivity within same node" >> same_node_test.txt
          echo "- NV ingest processing on same node" >> same_node_test.txt
          echo "- No cross-node networking required" >> same_node_test.txt
          echo "" >> same_node_test.txt
          echo "Expected Results:" >> same_node_test.txt
          echo "- Document should be processed successfully" >> same_node_test.txt
          echo "- Collection should show non-zero entity count" >> same_node_test.txt
          echo "- Vectors should be stored in Milvus" >> same_node_test.txt
          echo "- Processing should complete without errors" >> same_node_test.txt
          echo ""
          echo "Timestamp: $(date)" >> same_node_test.txt
          echo "‚úÖ Same-node test document created"
          echo ""
          echo "3. Creating same_node_test collection..."
          curl -s -X POST http://10.233.51.201:8082/collection \
            -H "Content-Type: application/json" \
            -d '{"collection_name": "same_node_test"}'
          echo ""
          echo ""
          echo "4. Uploading document for same-node test..."
          response=$(curl -s -X POST http://10.233.51.201:8082/documents \
            -F "documents=@same_node_test.txt" \
            -F 'data={"collection_name": "same_node_test"}')
          echo "Upload response: $response"
          echo ""
          if echo "$response" | grep -q "task_id"; then
            echo "‚úÖ Document uploaded successfully!"
            task_id=$(echo "$response" | grep -o '"task_id":"[^"]*"' | cut -d'"' -f4)
            echo "üìã Task ID: $task_id"
            echo ""
            echo "5. Waiting 120 seconds for processing..."
            sleep 120
            echo ""
            echo "6. Checking same-node collections status..."
            curl -s http://10.233.51.201:8082/collections
            echo ""
          else
            echo "‚ùå Document upload failed!"
          fi
          echo ""
          echo "=== SAME-NODE TEST COMPLETE ==="
      restartPolicy: Never
